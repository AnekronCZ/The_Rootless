#textdomain wesnoth-rtl

[scenario]
    id=04_The_Dark
    name= _ "The Dark"
    map_data="{~add-ons/The_Rootless/maps/04_The_Dark.map}"
    {TURNS 40 35 35}
    next_scenario=05a_The_Fire
    victory_when_enemies_defeated=no

    {SCENARIO_MUSIC underground.ogg}
    {EXTRA_SCENARIO_MUSIC into_the_shadows.ogg}
    {EXTRA_SCENARIO_MUSIC weight_of_revenge.ogg}

    {UNDERGROUND}
    {DEATHS_THE_DARK}
    {STAFF_OF_HAUNTING}
    {RECALL_DISCOUNT}
    {MAIN_CHARACTERS_EVENTS}
    {STUURG_LEVELUP}
    {ARCHER_LEVELUP}

    [time_area] #lava cave looks more red and favors neither chaotic nor lawful units
        {SCHEDULE_LAVA_CAVE}
        x="41,42,42,43,43,44,45,46,47,47,48,48,49,49,50,50,51,51,52,52,53,53"
        y="15-17,9,14-19,9-12,14-20,8-19,9-20,9-20,9-11,13-20,8-10,13-20,9-10,12-20,8-10,12-18,8-11,15-16,7-8,10-11,7-8,11-12"
    [/time_area]

    [story]
        [part]
            music=northerners-old.ogg
            background=story-orc.jpg
            story= _ "The underground tunnels were monotonous at first. Then the orcs passed by the dwarven burial grounds deep beneath the Heart Mountains and came upon a cave-in. Toruk wanted to return to the nearest junction and find a way through the side passages, but Arshag had another idea."
        [/part]
        [part]
            background=story-orc.jpg
            story= _ "The tunnels crossed a cave that, according to the dwarven map, ran in roughly the right direction. The wolves could smell some vermin from it, but what orc would be frightened by a rat or a bat?"
        [/part]
    [/story]

    {RTL_TRACK {JOURNEY_04_NEW}}

    [side]
        side=1
        controller=human
        {GOLD 250 230 210}
        {INCOME 3 2 1}
        team_name=Orcs
        user_team_name= _ "Orcs"
        {FLAG_VARIANT6 ragged}
        recruit="Orcish Archer,Goblin Spearman,Orcish Grunt,Orcish Assassin"
        type=Orcish Assassin
        id=Arshag
        shroud=yes
        fog=no
        unrenamable=yes
        facing=nw
        name= _ "Arshag"
        profile=portraits/arshag.png
        x,y=10,18
        [modifications]
            {TRAIT_INTELLIGENT}
        [/modifications]
        canrecruit=yes
    [/side]

    [side]
        side=2
        controller=ai
        hidden=yes
        team_name=Orcs
        user_team_name= _ "Trolls"
        {FLAG_VARIANT ragged}
        color=purple
        type=Fog Clearer
        x,y=39,18
    [/side]

    [side]
        side=3
        controller=ai
        hidden=yes
        team_name=Monsters
        user_team_name= _ "Monsters"
        color=green
        [ai]
            village_value=0
            aggression=0.8
        [/ai]
    [/side]

    [side]
        side=4
        controller=ai
        hidden=yes
        team_name=Undead
        user_team_name= _ "Undead"
        color=white
        shroud=no
        [ai]
            village_value=0
            aggression=0.8
            [goal]
                [criteria]
                    side=1
                [/criteria]
                value=5
            [/goal]
        [/ai]
        {FLAG_VARIANT undead}
    [/side]

    [event]
        name=prestart

        {ROOTLESS_HELP}
        {HINT_TROLL}
        {PLACE_IMAGE (scenery/archmage.png) 9 15}
        {PLACE_IMAGE (units/monsters/firewraith/firewraith.png) 8 15}
        {PLACE_IMAGE (items/coffin-closed.png) 24 15}
        {PLACE_IMAGE (items/coffin-closed.png) 28 15}
        {PLACE_IMAGE (items/stone-tablet.png) 4 18}
        {PLACE_IMAGE (items/bonestack.png) 3 18}
        {PLACE_IMAGE (items/bonestack.png) 3 19}
        {PLACE_IMAGE (items/bonestack.png) 5 18}
        {PLACE_IMAGE (items/bonestack.png) 5 19}
        {PLACE_IMAGE (scenery/monolith4.png) 5 1}
        {PLACE_IMAGE (items/barrel.png) 40 7}
        {PLACE_IMAGE (scenery/monolith3.png) 46 15}

        {VARIABLE ghoul_ee 1}
        {VARIABLE arshag_angry 0}
        {VARIABLE curse_lifted no}
#ifdef EASY
        {VARIABLE bridge1 0}
        {VARIABLE bridge2 0}
#endif

        [time_area]
            x="0,1,2,3,4,5,6,7,8"
	        y="0-2,0-3,0-2,0-3,0-2,0-3,0-2,0-3,0-2"
            {MORNING}
        [/time_area] 

        [recall]
            id=Toruk
        [/recall]

        [objectives]

            [objective]
                description= _ "Move Arshag on the path to the drakes"
                condition=win
                [show_if]
                    [have_unit]
                        id=Stuurg
                        side=1
                    [/have_unit]
                [/show_if]
            [/objective]

            [objective]
                caption="Or:"
                description= _ "Move Arshag on the path to the depths"
                condition=win
                [show_if]
                    [have_unit]
                        id=Linaera
                    [/have_unit]
                [/show_if]
            [/objective]

            [objective]
                description= _ "Move Arshag to the end of the tunnels"
                condition=win
                [show_if]
                    [not]
                        [have_unit]
                            id=Stuurg
                            side=1
                        [/have_unit]
                    [/not]
                [/show_if]
            [/objective]

            [objective]
                caption= _ "Optional objective:"
                description= "Find the place for the ritual to break the undead curse"
                condition=win
                [show_if]
                    [have_unit]
                        id=Stuurg
                        side=1
                    [/have_unit]
                    [and]
                        [variable]
                            name=curse_lifted
                            not_equals=yes
                        [/variable]
                    [/and]
                [/show_if]
            [/objective]

            [objective]
                description= _ "Death of Arshag"
                condition=lose
            [/objective]

            [objective]
                description= _ "Death of Stuurg"
                condition=lose
                [show_if]
                    [have_unit]
                        id=Stuurg
                    [/have_unit]
                [/show_if]
            [/objective]

            [objective]
                description= _ "Death of Toruk"
                condition=lose
            [/objective]

            {TURNS_RUN_OUT}

            [note]
                description="The tunnel to the drakes is marked in red, while the tunnel to the depths is marked in green."
                [show_if]
                    [have_unit]
                        id=Stuurg
                    [/have_unit]
                    [and]
                        [have_unit]
                            id=Linaera
                        [/have_unit]
                    [/and]
                [/show_if]
            [/note]

            [gold_carryover]
                carryover_percentage=20
                bonus=no
            [/gold_carryover]

        [/objectives]

    [/event]

    [event]
        name=start

        [message]
            speaker=Arshag
            message= _ "What do you think we'll find in these tunnels?"
        [/message]

        [message]
            speaker=Toruk
            message= _ "I'm not sure.
            
I believe you'll get us safely out of them, though."
        [/message]

        [message]
            speaker=Arshag
            message= _ "That's very strange to hear from you."
        [/message]

        [message]
            speaker=Toruk
            message= _ "You've proven your worth as a chief, Arshag."
        [/message]

        [message]
            speaker=Toruk
            message= _ "I miss my old home far to the east every day.
            
After the madness of the war against humans I no longer dared to hope for a new one."
        [/message]

        [message]
            speaker=Arshag
            message= _ "And now you do?"
        [/message]

        [message]
            speaker=Toruk
            message= _ "I'm starting to believe I might get to at least see it before my last breath."
        [/message]

    [/event]

    [event] #ghoul easter egg
        name=moveto
        first_time_only=no
        [filter]
            side=1
            x,y=4,18
        [/filter]
        [message]
            speaker=narrator
            message= _ "The piled skulls whisper:

<span font-style='italic'>Praise be to the Devourer.
The name starts with an N.
The name ends with an N.</span>"
            image=wesnoth-icon.png
        [/message]
    [/event]

    [event]
        name=moveto
        first_time_only=no
        [filter]
            side=1
            x,y=3,19
        [/filter]
        [filter_condition]
            [variable]
                name=ghoul_ee
                greater_than_equal_to=1
            [/variable]
        [/filter_condition]
        [if]
            [variable]
                name=ghoul_ee
                numerical_equals=1
            [/variable]
            [then]
                {VARIABLE ghoul_ee 2}
                [sound]
                    name=wail.wav
                [/sound]
                [remove_item]
                    x,y=3,19
                [/remove_item]
                {PLACE_IMAGE (items/bonestack-activated.png) 3 19}
            [/then]
            [else]
                {EE_RESET}
            [/else]
        [/if]
    [/event]

    [event]
        name=moveto
        first_time_only=no
        [filter]
            side=1
            x,y=3,18
        [/filter]
        [filter_condition]
            [variable]
                name=ghoul_ee
                greater_than_equal_to=1
            [/variable]
        [/filter_condition]
        [if]
            [variable]
                name=ghoul_ee
                numerical_equals=2
            [/variable]
            [then]
                {VARIABLE ghoul_ee 3}
                [sound]
                    name=wail.wav
                [/sound]
                [remove_item]
                    x,y=3,18
                [/remove_item]
                {PLACE_IMAGE (items/bonestack-activated.png) 3 18}
            [/then]
            [else]
                {EE_RESET}
            [/else]
        [/if]
    [/event]

    [event]
        name=moveto
        first_time_only=no
        [filter]
            side=1
            x,y=5,19
        [/filter]
        [filter_condition]
            [variable]
                name=ghoul_ee
                greater_than_equal_to=1
            [/variable]
        [/filter_condition]
        [if]
            [variable]
                name=ghoul_ee
                numerical_equals=3
            [/variable]
            [then]
                {VARIABLE ghoul_ee 4}
                [sound]
                    name=wail.wav
                [/sound]
                [remove_item]
                    x,y=5,19
                [/remove_item]
                {PLACE_IMAGE (items/bonestack-activated.png) 5 19}
            [/then]
            [else]
                {EE_RESET}
            [/else]
        [/if]
    [/event]

    [event]
        name=moveto
        first_time_only=no
        [filter]
            side=1
            x,y=5,18
        [/filter]
        [filter_condition]
            [variable]
                name=ghoul_ee
                greater_than_equal_to=1
            [/variable]
        [/filter_condition]
        [if]
            [variable]
                name=ghoul_ee
                numerical_equals=4
            [/variable]
            [then]
                [remove_item]
                    x,y=5,18
                [/remove_item]
                {PLACE_IMAGE (items/bonestack-activated.png) 5 18}
                {CLEAR_VARIABLE ghoul_ee}
                [scroll_to]
                    highlight=yes
                    x,y=4,16
                [/scroll_to]
                [sound]
                    name=open-chest.wav
                [/sound]
                {MODIFY_TERRAIN Rr^Pr|o 4 16}
                {MODIFY_TERRAIN Rr^Pr\o 5 12}
            [/then]
            [else]
                {EE_RESET}
            [/else]
        [/if]
    [/event]

    [event] #talking part of the ghoul easter egg
        name=moveto
        first_time_only=yes
        [filter]
            side=1
            x,y=4,14
        [/filter]

        [message]
            speaker=narrator
            image=wesnoth-icon.png
            message= _ "*knock knock*"
        [/message]

        [modify_unit]
            [filter]
                x,y=4,14
            [/filter]
            facing=sw
        [/modify_unit]

        {VARIANT_SAY "Who there?" "Who'sss there?" "Who's there?"}

        [unit]
            type=Ghoul
            id=Ghouling ghoul
            x,y=3,15
            facing=ne
            side=4
        [/unit]

        [message]
            speaker=Ghouling ghoul
            message= _ "Excuse me, have you heard about the ghouls, the finest beings in all Irdya?"
        [/message]

        [message]
            speaker=unit
            [option]
                label= _ "I haven't, tell me more!"
                [command]
                    [message]
                        speaker=Ghouling ghoul
                        message= _ "But of course!

Let me invite you to our annual Ghoul Appreciation Conference, soon in a cave near you!

You'll learn everything there is to know about ghouls, I promise."
                    [/message]
                    {VARIANT_SAY "We still have work." "We are in a middle of sssomething here." "We are in a middle of something here."}
                    [message]
                        speaker=Ghouling ghoul
                        message= _ "It's not a problem, we'll wait until you sort it out."
                    [/message]
                    {VARIABLE easter_egg_unlocked yes}
                    [message]
                        speaker=narrator
                        image=help/ghoul-overlay.png
                        message= _ "You've unlocked a bonus scenario that you can play after completing the main campaign story!"
                    [/message]
                [/command]
            [/option]
            [option]
                label= _ "I have, but I'm willing to learn more."
                [command]
                    [message]
                        speaker=Ghouling ghoul
                        message= _ "Then let me invite you to our annual Ghoul Appreciation Conference, soon in a cave near you!

You'll learn everything there is to know about ghouls, I promise."
                    [/message]
                    {VARIANT_SAY "We still have work." "We are in a middle of sssomething here." "We are in a middle of something here."}
                    [message]
                        speaker=Ghouling ghoul
                        message= _ "It's not a problem, we'll wait until you sort it out."
                    [/message]
                    {VARIABLE easter_egg_unlocked yes}
                    [message]
                        speaker=narrator
                        image=help/ghoul-overlay.png
                        message= _ "You've unlocked a bonus scenario that you can play after completing the main campaign story!"
                    [/message]
                [/command]
            [/option]
            [option]
                label= _ "I don't care about ghouls. Get lost!"
            [/option]
        [/message]

            [message]
                speaker=Ghouling ghoul
                message= _ "Well, time for me to get going."
            [/message]

            [kill]
                id=Ghouling ghoul
                animate=no
            [/kill]
    [/event]

    [event] #some vermin in the cave
        name=turn 2
        {GENERIC_UNIT 3 (Giant Rat) 10 13}
        {GENERIC_UNIT 3 (Giant Rat) 7 12}
        {GENERIC_UNIT 3 (Giant Rat) 8 10}
        {GENERIC_UNIT 3 (Vampire Bat) 19 17}
        #ifdef EASY
        {GENERIC_UNIT 3 (Vampire Bat) 22 13}
        #else
        {GENERIC_UNIT 3 (Blood Bat) 22 13}
        #endif
    [/event]

    [event]
        name=turn 3
        {GENERIC_UNIT 3 (Rock Scorpion) 15 10}
        {GENERIC_UNIT 3 (Blood Bat) 20 7}
        #ifdef EASY
        {GENERIC_UNIT 3 (Vampire Bat) 3 10}
        #else
        {GENERIC_UNIT 3 (Blood Bat) 3 10}
        #endif
    [/event]

    [event] #the undead arrive
        name=turn 4
        [unit]
            type=Elvish Champion Kalian
            id=Lord Logalmier
            name=_ "Lord Logalmier"
            canrecruit=yes
            profile="portraits/logalmier.png"
            x,y=4,1
            facing=se
            side=3
        [/unit]
        [unit]
            type=Dwarvish Pathfinder
            id=Traitor
            x,y=5,2
            facing=se
            side=3
            [object]
                [effect]
                    apply_to=image_mod
                    add=RC(magenta>brown)
                [/effect]
            [/object]
        [/unit]
        [unit]
            type=Elvish Enchantress
            id=Zofaria
            name=_ "Zofaria"
            [modifications]
                {TRAIT_LOYAL_HERO}
                [object]
                    [effect]
                        apply_to=image_mod
                        add=RC(magenta>black)
                    [/effect]
                    [effect]
                        apply_to=attack
                        name=faerie fire
                        set_description=shadow wave
                        set_name=shadow wave
                        set_icon=attacks/dark-missile.png
                    [/effect]
                [/object]
                [object]
                    [effect]
                        apply_to=new_animation
                        [attack_anim]
                            [filter_attack]
                                name=shadow wave
                            [/filter_attack]
                            start_time=-450
                            {MISSILE_FRAME_CHILL_WAVE 0 -5}
                            {SOUND:HIT_AND_MISS magic-dark.ogg magic-dark-miss.ogg -450}
                            [frame]
                                image="units/elves-wood/enchantress-magic-[1,2*5,1].png:75"
                                halo=halo/undead/black-magic-[1~5].png
                                halo_x,halo_y=0,-10
                            [/frame]
                        [/attack_anim]
                    [/effect]
                [/object]
            [/modifications]
            x,y=6,1
            facing=se
            side=3
        [/unit]
        
        [remove_shroud]
            x="0,1,2,3,4,5,6,7,8"
	        y="0-2,0-3,0-2,0-3,0-2,0-3,0-2,0-3,0-2"
        [/remove_shroud]

        [message]
            speaker=Lord Logalmier
            message= _ "So you're sure they're going down this tunnel?"
        [/message]

        [message]
            speaker=Traitor
            message= _ "Yes."
        [/message]

        [message]
            sound=gold.ogg
            speaker=Lord Logalmier
            message= _ "There's your money."
        [/message]

        {MOVE_UNIT id=Traitor 8 2}

        [kill]
            id=Traitor
            animate=no
        [/kill]

        [message]
            speaker=Lord Logalmier
            message= _ "Zofaria, are you ready?"
        [/message]

        [message]
            speaker=Zofaria
            message= _ "Almost, my lord.
            
I can feel the restless dead in their tomb, but they resent my touch.

Many of them fell years ago when you attacked the dwarven kingdom. They don't like being woken by an elf."
        [/message]

        [message]
            speaker=Lord Logalmier
            message= _ "I cannot say I approve of your methods.
            
You've learned these dark arts from Wesfolk, the very same people that <span font-style='italic'>started</span> this orcish invasion."
        [/message]

        [message]
            speaker=Zofaria
            message= _ "The dark arts are but a tool, my lord.
            
In good hands they can undo what they once caused."
        [/message]

        [message]
            speaker=Zofaria
            message= _ "<span font-style='italic'>You who lay in a dreamless sleep under this mountain, be cursed!

May you grow vengeful and restless in your slumber!

Arise and feast on the living!</span>"
        [/message]

        [animate_unit]
            flag=attack
            [filter]
                id=Zofaria
            [/filter]
            hits=kill
            [primary_attack]
                name=shadow wave
            [/primary_attack]
            [facing]
                x=6
                y=2
            [/facing]
        [/animate_unit]

        {QUAKE "rumble.ogg"}

        [message]
            speaker=Toruk
            message= _ "What was that?"
        [/message]

        [message]
            speaker=Lord Logalmier
            message= _ "Let's hope the dead take care of the orcish band."
        [/message]

        [place_shroud]
            x="0,1,2,3,4,5,6,7,8"
	        y="0-2,0-3,0-2,0-3,0-2,0-3,0-2,0-3,0-2"
        [/place_shroud]

        [kill]
            id=Lord Logalmier
            animate=no
        [/kill]

        [kill]
            id=Zofaria
            animate=no
        [/kill]

        {GENERIC_UNIT 4 (Skeleton) 24 14}
        {GENERIC_UNIT 4 (Skeleton Archer) 25 17}
        {GENERIC_UNIT 4 (Skeleton Archer) 30 14}

    [/event]

    [event] #looting the crypt
        name=moveto

        [filter]
            x,y=24,15
            side=1
            [not]
                [filter_wml]
                    [modifications]
                        [object]
                            id=cloak_gift
                        [/object]
                    [/modifications]
                [/filter_wml]
            [/not]
        [/filter]

        {VARIANT_SAY "Oh! Shiny things on dead dwarf!" "There are some jewelsss on this corpssse!" "There are some jewels on this corpse!"}

        [sound]
            name=gold.ogg
        [/sound]

        [message]
            speaker=narrator
            message= _ "You get 50 gold pieces."
            image=wesnoth-icon.png
        [/message]

        [gold]
            side=1
            amount=50
        [/gold]

        [remove_item]
            x,y=24,15
        [/remove_item]
        [remove_item]
            x,y=28,15
        [/remove_item]

        {PLACE_IMAGE (items/coffin-open.png) 24 15}
        {PLACE_IMAGE (items/coffin-open.png) 28 15}

        [unit]
#ifdef EASY
            type=Revenant
#else
            type=Draug
#endif
            name=_ "Protector"
            x,y=28,15
            facing=nw
            side=4
        [/unit]

        [sound]
            name=skeleton-hit-1.ogg
        [/sound]

        [scroll_to]
            x,y=28,15
        [/scroll_to]

        [delay]
            time=500
        [/delay]

        [message]
            speaker=unit
            message= _ "Oh."
        [/message]

        {VARIABLE protector_awake yes}
        
    [/event]

    [event] #looting the crypt with the cloak gift
        name=moveto

        [filter]
            x,y=24,15
            side=1
            [filter_wml]
                [modifications]
                    [object]
                        id=cloak_gift
                    [/object]
                [/modifications]
            [/filter_wml]
        [/filter]

        {VARIANT_SAY "Oh! Shiny things on dead dwarf!" "There are some jewelsss on this corpssse!" "There are some jewels on this corpse!"}

        [sound]
            name=gold.ogg
        [/sound]

        [message]
            speaker=narrator
            message= _ "You get 50 gold pieces."
            image=wesnoth-icon.png
        [/message]

        [gold]
            side=1
            amount=50
        [/gold]

        [remove_item]
            x,y=24,15
        [/remove_item]
        [remove_item]
            x,y=28,15
        [/remove_item]

        {PLACE_IMAGE (items/coffin-open.png) 24 15}
        {PLACE_IMAGE (items/coffin-open.png) 28 15}

        [unit]
            type=Draug
            id=ProtectorKill
            x,y=28,15
            facing=nw
            side=4
        [/unit]

        [sound]
            name=skeleton-hit-1.ogg
        [/sound]

        [scroll_to]
            x,y=28,15
        [/scroll_to]

        [delay]
            time=500
        [/delay]

        [message]
            speaker=narrator
            message= _ "The undead protector searches the tomb for the one who has awakened him.
            
Yet even his unnatural senses can't pierce the cloak made of spider's thread."
            image=wesnoth-icon.png
        [/message]

        [kill]
            id=ProtectorKill
            animate=yes
        [/kill]

        {VARIANT_SAY "Phew, I was lucky!" "Phew, I wasss lucky!" "Phew, I was lucky!"}

        {VARIABLE protector_awake yes}
        
    [/event]

    [event] #the other coffin does nothing
        name=moveto
        [filter]
            x,y=28,15
            side=1
        [/filter]

        [filter_condition]
            [variable]
                name=protector_awake
                boolean_not_equals=yes
            [/variable]
        [/filter_condition]

        [message]
            speaker=narrator
            message= _ "The lid stays in place despite best effort."
            image=wesnoth-icon.png
        [/message]
        
    [/event]

    [event] #fisherman encounter, naga version
        name=moveto
        first_time_only=yes
        [filter]
            side=1
            id=Naga
            x,y=28,19
        [/filter]
        [filter_condition]
            [variable]
                name=gaethyn_discovered
                not_equals=yes
            [/variable]
            [and]
                [variable]
                    name=curse_lifted
                    not_equals=yes
                [/variable]
            [/and]
        [/filter_condition]
        [unit]
            type=Walking Corpse
            id=Gaethyn
            name=_ "Gaethyn"
            x,y=28,20
            facing=nw
            side=1
            [modifications]
                {TRAIT_LOYAL}
                [object]
                    [effect]
                        apply_to=movement_costs
                        replace=yes
                        [movement_costs]
                            deep_water=1
                            shallow_water=1
                            swamp_water=1
                            reef=2
                        [/movement_costs]
                    [/effect]
                    [effect]
                        apply_to=defense
                        replace=yes
                        [defense]
                            deep_water=50
                            shallow_water=40
                            swamp_water=40
                            reef=30
                        [/defense]
                    [/effect]
                    [effect]
                        apply_to=overlay
                        add="misc/gift-icon.png"
                    [/effect] 
                [/object]
            [/modifications]
        [/unit]

        {VARIABLE gaethyn_discovered yes}

        [message]
            speaker=Naga
            message= _ "Another ssstinking corpssse!"
        [/message]

        [message]
            speaker=Gaethyn
            message= _ "By the Lords of Light, where?"
        [/message]

        [message]
            speaker=Naga
            message= _ "It ssspeaksss?"
        [/message]

        [message]
            speaker=Gaethyn
            message= _ "Oh, where are my manners? You've probably never seen a human before.
            
It's only about a year since we arrived on this continent."
        [/message]

        [message]
            speaker=Naga
            message= _ "I've ssseen enough humansss for my tassste.
            
Jussst not a dead one that talksss."
        [/message]

        [message]
            speaker=Gaethyn
            message= _ "What do you mean by dead?"
        [/message]

        [message]
            speaker=Naga
            message= _ "You haven't noticed that your ear just fell off?"
        [/message]

        [message]
            speaker=Gaethyn
            message= _ "Uh. I've probably forgot to eat for several weeks while fishing. Or sleep for that matter."
        [/message]

        [message]
            speaker=Naga
            message= _ "Fissshing?"
        [/message]

        [message]
            speaker=Gaethyn
            message= _ "Dwarvish merchants told me about a strange fish that lives deep in these caves.

They said it has arms and even throws things sometimes. How crazy is that?"
        [/message]

        [message]
            speaker=Gaethyn
            message= _ "I guess I could still catch one."
        [/message]
    [/event]

    [event] #fisherman encounter, ghost version
        name=moveto
        first_time_only=yes
        [filter]
            side=1
            type_adv_tree=Ghost
            x,y=28,19
        [/filter]
        [filter_condition]
            [variable]
                name=gaethyn_discovered
                not_equals=yes
            [/variable]
            [and]
                [variable]
                    name=curse_lifted
                    not_equals=yes
                [/variable]
            [/and]
        [/filter_condition]
        [unit]
            type=Walking Corpse
            id=Gaethyn
            name=_ "Gaethyn"
            x,y=28,20
            facing=nw
            side=1
            [modifications]
                {TRAIT_LOYAL}
                [object]
                    [effect]
                        apply_to=movement_costs
                        replace=yes
                        [movement_costs]
                            deep_water=1
                            shallow_water=1
                            swamp_water=1
                            reef=2
                        [/movement_costs]
                    [/effect]
                    [effect]
                        apply_to=defense
                        replace=yes
                        [defense]
                            deep_water=50
                            shallow_water=40
                            swamp_water=40
                            reef=30
                        [/defense]
                    [/effect]
                    [effect]
                        apply_to=overlay
                        add="misc/gift-icon.png"
                    [/effect] 
                [/object]
            [/modifications]
        [/unit]

        {VARIABLE gaethyn_discovered yes}

        [message]
            speaker=unit
            message= _ "Another corpse? This one looks like a human."
        [/message]

        [message]
            speaker=Gaethyn
            message= _ "Oh, by the Lords of Light, it's a ghost!"
        [/message]

        [message]
            speaker=unit
            message= _ "Are you afraid of me? You realise you're undead yourself?"
        [/message]

        [message]
            speaker=Gaethyn
            message= _ "What? Oh, I see now. My hand is rotten almost to the bone.
            
I've probably forgot to eat for several weeks while fishing. Or sleep for that matter."
        [/message]

        [message]
            speaker=unit
            message= _ "You seem very unconcerned about that."
        [/message]

        [message]
            speaker=Gaethyn
            message= _ "It happens to everyone sooner or later, I guess."
        [/message]

        [message]
            speaker=unit
            message= _ "Well, when you put it this way..."
        [/message]

        [message]
            speaker=Gaethyn
            message= _ "Anyway, dwarvish merchants told me about a strange fish that lives deep in these caves.

They said it has arms and even throws things sometimes. How crazy is that?"
        [/message]

        [message]
            speaker=Gaethyn
            message= _ "I guess I could still catch one."
        [/message]

        [message]
            speaker=unit
            message= _ "Come with us. I'll enjoy not being the only dead person for a change."
        [/message]
    [/event]

    [event] #meeting the trolls
        name=moveto
        first_time_only=yes
        [filter]
            side=1
            x="10,11,12,13,13,14,14,15,15,16,17,18,19,20,21,22,23,24,25,26,27,28"
	        y="4-5,4-6,3-5,4-5,8-9,3-5,7-9,4-6,8-10,3-10,3-10,3-8,4-9,4-8,4-9,4-9,6-11,6-11,7-11,8-11,10-12,10-11"
        [/filter]

#ifdef EASY
        {WC "Walking Corpse" rat 16 6}
#else
        {WC Soulless rat 16 6}
#endif
        {WC "Walking Corpse" troll 20 6}
        {WC Soulless spider 21 5}
#ifdef HARD
        {WC Soulless dwarf 22 9}
#else
        {WC "Walking Corpse" dwarf 22 9}
#endif
        {WC Soulless swimmer 28 7}
        {WC Soulless bat 17 9}
        {GENERIC_UNIT 4 (Skeleton Archer) 21 7}
        {GENERIC_UNIT 4 (Skeleton Archer) 19 5}
        {GENERIC_UNIT 4 (Bone Shooter) 17 7}
        {GENERIC_UNIT 2 (Troll Whelp) 24 8}
        {GENERIC_UNIT 2 (Troll Whelp) 25 10}
        {GENERIC_UNIT 2 (Troll Whelp) 26 11}
        {GENERIC_UNIT 2 (Troll Whelp) 23 11}

        [unit]
            side=2
            id=Angry Troll
            type=Troll Whelp
            x,y=19,4
            facing=sw
        [/unit]

        [unit]
            side=2
            type=RTL Great Shaman
            id=Stuurg
            unrenamable=yes
            name= _ "Stuurg"
            x,y=25,9
            facing=nw
            [modifications]
                {TRAIT_LOYAL_HERO}
                {TRAIT_STRONG}
            [/modifications]
        [/unit]

        [micro_ai]
            side=2
            id=Stuurg
            ai_type=zone_guardian
            action=add
            [filter_location]
                x,y=25,9
            [/filter_location]
        [/micro_ai]

        [micro_ai]
            side=4
            id=BurnedOne
            ai_type=zone_guardian
            action=add
            [filter_location]
                x,y=46,11
            [/filter_location]
        [/micro_ai]

        [remove_shroud]
            x="10,11,12,13,13,14,14,15,15,16,17,18,19,20,21,22,23,24,25,26,27,28"
	        y="4-5,4-6,3-5,4-5,8-9,3-5,7-9,4-6,8-10,3-10,3-10,3-8,4-9,4-8,4-9,4-9,6-11,6-11,7-11,8-11,10-12,10-11"
        [/remove_shroud]

        [message]
            speaker=Angry Troll
            message= _ "More dead coming! These ones darker, got long fangs."
        [/message]

        [message]
            speaker=Stuurg
            message= _ "Are they even corpses?"
        [/message]

        [message]
            speaker=Angry Troll
            message= _ "No matter, shaman. We smash their skulls, then see what they are."
        [/message]

        {VARIANT_SAY "Hey you! You, the player! You are ruining the immersion a lot by using debug. Can you at least go into the effort of discovering the trolls with a non-troll unit?" "Wait a minute! We're not undead." "Wait a minute! We're not undead."}

        [message]
            speaker=Toruk
            message= _ "Did you say you have a shaman?"
        [/message]

        [message]
            speaker=Angry Troll
            message= _ "Talk after we finish off walking dead."
        [/message]
        
    [/event]

    [event] #trolls join the party
        name=side 2 turn
        first_time_only=no
        [filter_condition]
            [have_unit]
                id=Stuurg
                side=2
            [/have_unit]
        [/filter_condition]
        [if]
            [have_unit]
                side=4
                x="16,17,18,19,20,21,22,23,24,25,26,27,28"
	            y="5-6,5-7,4-7,4-8,4-8,4-9,8-9,9-11,8-11,8-11,8-11,11,11"
            [/have_unit]
            [else]
                [message]
                    speaker=Stuurg
                    message= _ "Looks like we're rid of the undead, at least for now. My name is Stuurg."
                [/message]

                [message]
                    speaker=Arshag
                    message= _ "I'm Arshag and my grumpy old friend here's called Toruk. Are you really a shaman?"
                [/message]

                [message]
                    speaker=Toruk
                    message= _ "Can you hear the whispers of rock, wind and water?"
                [/message]

                [message]
                    speaker=Stuurg
                    message= _ "I can. I might even be able to call on fire to get us rid of this undead infestation, but it's power is too weak here, by the river."
                [/message]

                [message]
                    speaker=Arshag
                    message= _ "We thought we lost the last one. That with the death of my mother, shamans are gone from this world for good."
                [/message]

                [message]
                    speaker=Stuurg
                    message= _ "It can still happen.
                    
The dwarves aren't very fond of my people. They never hesitate to force us from our homes in their endless search for iron and gold."
                [/message]

                [message]
                    speaker=Stuurg
                    message= _ "The elves are even worse.
                    
Their magic is bright and terrible. They care for trees and plants, but not for the rock from which they came. And they fear what they don't understand.

It probably doesn't help that we look like beasts to their eyes."
                [/message]

                [message]
                    speaker=Toruk
                    message= _ "Well, to us they themselves look gaunt and sickly pale."
                [/message]

                [message]
                    speaker=Arshag
                    message= _ "In fact, we are fleeing from the elves through these caves. Can you help us get north?"
                [/message]

                [message]
                    speaker=Stuurg
                    message= _ "There is a path, but it's one we no longer dare to follow. Fire breathing lizards dwell on the peaks around it's opening.
                    
My flames aren't much help against them. Neither, it seems, are our fists or stones."
                [/message]

                [message]
                    speaker=Arshag
                    message= _ "We have quite a few other weapons among us. Will you go with us?"
                [/message]

                [message]
                    speaker=Stuurg
                    message= _ "We will, and not just because of the dead.
                    
This place is doomed. The roofs of these tunnels will collapse and the hot, liquid stone will flood them. I saw it in the flames."
                [/message]

                [message]
                    speaker=Toruk
                    message= _ "You can see that? When will all of this happen?"
                [/message]

                [message]
                    speaker=Stuurg
                    message= _ "Before you'd grow a new beard if you shaved it off, old orc."
                [/message]

                [modify_unit]
                    [filter]
                        side=2
                        [not]
                            type=Fog Clearer
                        [/not]
                    [/filter]
                    side=1
                [/modify_unit]

                [modify_side] #repurposing ally troll side for the encounter with Linaera
                    side=2
                    color=blue
                    {FLAG_VARIANT loyalist}
                    user_team_name=Linaera
                [/modify_side]
                
                [store_villages]
                    owner_side=2

                    variable=troll_villages
                [/store_villages]

                [foreach]
                    array=troll_villages
                    [do]
                        [capture_village]
                            side=1
                            x,y=$this_item.x,$this_item.y
                        [/capture_village]
                    [/do]
                [/foreach]

                {CLEAR_VARIABLE troll_villages}

                [allow_recruit]
                    side=1
                    type=Troll Whelp
                [/allow_recruit]

                [message]
                    speaker=narrator
                    message= _ "You can now recruit Troll Whelps."
                    image=wesnoth-icon.png
                [/message]

                {VARIABLE crypt "$($turn_number + 3)"} #so that the crypt starts raising more undead after a while

                [remove_shroud]
                    x,y=52,8
                [/remove_shroud]

                [redraw]
                [/redraw]

                {HIGHLIGHT_IMAGE 52 8 items/gohere.png ()}
                
                [show_objectives]
                [/show_objectives]

            [/else]
        [/if]
    [/event]

    [event] #encounter with Linaera
        name=moveto

        [filter]
            side=1
            x,y=40,2
        [/filter]

        [move_unit]
            x,y=40,2
            to_x=39
            to_y=3
        [/move_unit]

        [unit]
            side=2
            type=Silver Mage
            id=Linaera
            gender=female
            unrenamable=yes
            name= _ "Linaera"
            profile=portraits/linaera.png
            x,y=39,16
            facing=sw
            [modifications]
                {TRAIT_LOYAL_HERO}
            [/modifications]
        [/unit]

        [modify_unit]
            [filter]
                x,y=39,3
            [/filter]
            facing=ne
        [/modify_unit]

        [teleport]
            [filter]
                id=Linaera
            [/filter]
            x,y=40,2
            animate=yes
        [/teleport]

        [modify_unit]
            [filter]
                id=Linaera
            [/filter]
            facing=sw
        [/modify_unit]

        [message]
            x,y=39,3
            message= _ "What was that? She appeared out of thin air!"
        [/message]

        [message]
            speaker=Linaera
            message= _ "Stay back, orcs.

I don't have the best experience with your kind and won't hesitate to blast you with a spell."
        [/message]

        [message]
            speaker=Arshag
            message= _ "We mean no harm. Who are you and what do you want?"
        [/message]

        [message]
            speaker=Linaera
            message= _ "My name is Linaera.
            
I was sent by King Haldric to explore lands beyond the northern border. I'm trying to find a way back to Wesnoth."
        [/message]

        [message]
            speaker=Stuurg
            message= _ "Did you see any fire-breathing lizards back where you came from?"
        [/message]

        [message]
            speaker=Linaera
            message= _ "Enough for one lifetime.
            
They were the reason the King sent me. He wanted to keep an eye on them after their attack on Elensefar and only I am fast enough to keep up with their strong wings."
        [/message]

        [message]
            speaker=Toruk
            message= _ "Your powers don't help much in the caves, I reckon."
        [/message]

        [message]
            speaker=Arshag
            message= _ "There is a tunnel nearby that you can use. Or rather you could use it if it wasn't full of undead by now."
        [/message]

        [message]
            speaker=Linaera
            message= _ "Don't you worry, I can evade them just as simply as I would the living.
            
That being said, I appreciate the advice. I'll give you some too. Do not attempt to go through the land of the drakes. They're extemely dangerous."
        [/message]

        [teleport]
            [filter]
                id=Linaera
            [/filter]
            x,y=39,16
            animate=yes
        [/teleport]

        [move_unit]
            x,y=39,3
            to_x=40
            to_y=2
        [/move_unit]

        [capture_village]
            side=1
            x,y=40,2
        [/capture_village]

        [message]
            speaker=Toruk
            message= _ "What now? Is there any other way north?"
        [/message]

        [message]
            speaker=Stuurg
            message= _ "There is, but it leads through the darkest depths at the very roots of these mountains. We know not what dwells in the abyss."
        [/message]

        [message]
            speaker=Arshag
            message= _ "We'll decide once we have to. Now there's no time."
        [/message]

        {HIGHLIGHT_IMAGE 52 10 items/gohere-green.png ()}

        [remove_shroud]
            x,y=52,10
        [/remove_shroud]

        [redraw]
        [/redraw]

        [show_objectives]
        [/show_objectives]
        
    [/event]

    [event] #the pit randomly spawns some undead every turn + fire ghost gets healed
        name=new turn
        first_time_only=no
        [filter_condition]
            [variable]
                name=curse_lifted
                not_equals=yes
            [/variable]
        [/filter_condition]
        {VARIABLE undead_wave 4}
        {VARIABLE undead_count 0}
        [while]
        
            [have_unit]
                side=1
                id=Stuurg
            [/have_unit]
            [and]
                [variable]
                    name=undead_wave
                    greater_than=3
                [/variable]
            [/and]
            [and]
                [variable]
                    name=stop_wave
                    not_equals=yes
                [/variable]
            [/and]
            [and]
                [variable]
                    name=undead_count
#ifdef EASY
                    less_than=2 #todo: consider raising to 3 + adjusting rand bellow
#endif
#ifdef NORMAL
                    less_than=3
#endif
#ifdef HARD
                    less_than=4
#endif
                [/variable]
            [/and]
    
            [do]
    
                [set_variable]  
                    name=undead_wave
                    rand=Skeleton,Skeleton Archer,Ghost,Walking Corpse,Walking Corpse,Walking Corpse,Walking Corpse,Walking Corpse,Walking Corpse,Walking Corpse,Soulless,Soulless,Soulless
                [/set_variable]
                [set_variable]  
                    name=pick_variant
                    rand=spider,scorpion,dwarf,dwarf,dwarf,troll,troll,troll,rat,rat,rat,rat,bat,bat,bat,bat
                [/set_variable]
    
                [unit]
                    type=$undead_wave
                    variation=$pick_variant
                    x,y=38,9
                    facing=ne
                    side=4
                    placement=map_passable
                [/unit]

                
    
                [set_variable]
                    name=undead_wave
                    rand=1..7
                [/set_variable]
    
            [/do]
    
        [/while]
        {CLEAR_VARIABLE undead_wave}
        {CLEAR_VARIABLE pick_variant}
        {CLEAR_VARIABLE undead_count}

            
        [heal_unit]
            amount=8
            [filter]
                id=BurnedOne
                x="41,42,42,43,43,44,45,46,47,47,48,48,49,49,50,50,51,51,52,52,53,53"
                y="15-17,9,14-19,9-12,14-20,8-19,9-20,9-20,9-11,13-20,8-10,13-20,9-10,12-20,8-10,12-18,8-11,15-16,7-8,10-11,7-8,11-12"
            [/filter]
        [/heal_unit]

        [animate_unit]
            [filter]
                id=BurnedOne
                x="41,42,42,43,43,44,45,46,47,47,48,48,49,49,50,50,51,51,52,52,53,53"
                y="15-17,9,14-19,9-12,14-20,8-19,9-20,9-20,9-11,13-20,8-10,13-20,9-10,12-20,8-10,12-18,8-11,15-16,7-8,10-11,7-8,11-12"
            [/filter]
            flag=healing
            text=8
            red=255
            green=102
        [/animate_unit]

    [/event]

    [event] #show that the undead climb from the lower levels
        name=moveto

        [filter]
            side=1
            x="26,27,28,29,30,31,32,32,33,33,34"
	        y="3,3-4,3-4,3-5,3-5,3-6,2,4-6,3-4,6-7,3-5"
        [/filter]

        [unit]
            side=4
            type=Spectre
            id=BurnedOne
            unrenamable=yes
            name= _ "The Burned One"
            x,y=46,11
            facing=nw
            [modifications]
                [object]
                    [effect]
                        apply_to=overlay
                        add="misc/gift-icon.png"
                    [/effect]
                    [effect]
                        apply_to=hitpoints
                        increase_total=22
                    [/effect]
                    [effect]
                        apply_to=attack
                        range=melee
                        remove_specials=drains
                        set_type=fire
                        set_description=_ "fire blade"
                        increase_damage=-2
                        set_name=fire blade
                        set_icon="data/core/images/attacks/sword-flaming.png"
                    [/effect]
                    [effect]
                        apply_to=attack
                        range=ranged
                        set_type=fire
                        increase_attacks=1
                        increase_damage=5
                        set_name=fire breath
                        set_description=_ "fire breath"
                        set_icon="data/core/images/attacks/fire-blast.png"
                    [/effect]
                    [effect]
                        apply_to=new_animation
                        [attack_anim]
                            [filter_attack]
                                name=fire breath
                            [/filter_attack]
                            {MISSILE_FRAME_FIRE_BREATH 11,-34 11,15 24,-22 26,10}
                            start_time=-500
                            {SOUND:HIT_AND_MISS flame-big.ogg flame-big-miss.ogg -400}
                            [frame]
                                image="units/undead/spectre.png:50"
                            [/frame]
                            [frame]
                                sound=wail.wav
                                image="units/undead/spectre-se-attack-1.png:450"
                            [/frame]
                        [/attack_anim]
                    [/effect]
                    [effect]
                        apply_to=new_animation
                        [attack_anim]
                            [filter_attack]
                                name=fire blade
                            [/filter_attack]
                            alpha=0.8~0.5:126,0.5~0.8:126
                            offset=0.0~0.3,0.3~0.45,0.45~0.3,0.3~0.0
                            start_time=-250
                            offset=0.0~0.1,0.1~0.0
                            start_time=-400
                            [frame]
                                image="units/undead/spectre-se-attack-[1~12].png:60"
                            [/frame]
                            {SOUND:HIT_AND_MISS torch.ogg torch-miss.ogg -100}
                        [/attack_anim]
                    [/effect]
                    [effect]
                        apply_to=new_animation
                        [healing_anim]
                                start_time=-200
                                [frame]
                                    sound=fire.wav
                                [/frame]
                                [frame]
                                    halo=scenery/flames[01~15].png:50
                                [/frame]
                                [frame]
                                    sound=wail.wav
                                [/frame]
                        [/healing_anim]
                    [/effect]
                    [effect]
                        apply_to=new_ability
                        [abilities]
                            {ABILITY_BURNED}
                        [/abilities]
                    [/effect]
                    [effect]
                        apply_to=resistance
                        replace=yes
                        [resistance]
                            blade=80
                            pierce=80
                            impact=80
                            fire=10
                            cold=120
                        [/resistance]
                    [/effect]
                [/object]
            [/modifications]
        [/unit]

        [remove_shroud]
            x="26,27,28,29,30,31,32,32,33,33,34,34,35,36,37,38,39,40,41,42,43,44,45,45,46,47,48"
	        y="3,3-4,3-4,3-5,3-5,3-6,2,4-6,3-8,11,3-8,10-11,5-11,4-11,4-13,4-13,5-14,4-12,5-9,4-9,4-10,3-9,3-7,9,3-7,6-7,6"
        [/remove_shroud]

        [scroll_to]
            x,y=38,10
        [/scroll_to]

        [delay]
            time=500
        [/delay]

        [message]
            speaker=Stuurg
            message= _ "They're climbing from the lower levels. A great battle between us and the dwarves took place there years ago."
        [/message]

        [message]
            speaker=Arshag
            message= _ "Can we get around them?"
        [/message]

        [message]
            speaker=Stuurg
            message= _ "We can through the other tunnel.
            
But the fastest way to break the curse would be to fight our way to the red light there. Can you see it?"
        [/message]

        [scroll_to]
            x,y=46,15
        [/scroll_to]

        [remove_shroud]
            x="45,46,47"
	        y="15-16,14-16,15-16"
        [/remove_shroud]

        [delay]
            time=1000
        [/delay]

    [/event]

    [event]
        name=attack

        [filter]
            id=BurnedOne
        [/filter]
        [filter_second]
            side=1
        [/filter_second]

        [micro_ai]
            side=4
            id=BurnedOne
            ai_type=zone_guardian
            action=delete
        [/micro_ai]
    [/event]

    [event] #a little joke about how the barrels in Wesnoth always explode in campaigns
        name=moveto

        [filter]
            side=1
            x=40
	        y=7
        [/filter]

        {VARIANT_SAY "Dwarf barrel here." "Oh, an old dwarvisssh barrel full of that black dussst they put in their thundersssticksss." "Oh, an old dwarvish barrel full of that black dust they put in their thundersticks."}

        {VARIANT_SAY "Dwarf keep boom dust in barrel, but dust wet to make boom." "It could have blasssted a nice hole in that wall if it wasssn't lying there for ssso long." "It could have blasted a nice hole in that wall if it wasn't lying there for so long."}

    [/event]

    [event] #the entrance to the crypt grows, preventing the player from farming the undead
        name=turn $crypt

        {CLEAR_VARIABLE crypt}

        [scroll_to]
            x,y=26,15
        [/scroll_to]

        {QUAKE (rumble.ogg)}

        {MODIFY_TERRAIN Uu^Dr 22 14}
        {MODIFY_TERRAIN Uu^Dr 22 16}

        [redraw]  
        [/redraw]

        [unit]
            type=Draug
            x,y=22,14
            facing=nw
            side=4
        [/unit]

        [unit]
            type=Draug
            x,y=22,16
            facing=nw
            side=4
        [/unit]

        {GENERIC_UNIT 4 (Deathblade) 26 14}
        {GENERIC_UNIT 4 (Banebow) 27 17}
        {GENERIC_UNIT 4 (Revenant) 30 14}

        {VARIABLE crypt_wave yes}

        [delay]
            time=1500
        [/delay]

        [place_shroud]
            [filter_side]
                side=1
            [/filter_side]
            x="0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,19,20,20,21,21,22,23,24,25,26,27,28,29,30"
	        y="0-22,0-22,0-22,0-22,0-22,0-22,0-22,0-22,0-22,0-22,0-22,0-22,0-22,0-22,0-22,0-22,0-22,0-22,2-22,3-6,8-22,3-5,10-22,11-18,20-22,12-16,13-16,13-16,13-17,12-17,13-17,12-16,13-16,13-16"
        [/place_shroud]

        [redraw]  
        [/redraw]

    [/event]

    [event] #crypt spawns new undead each turn
        name=new turn
        first_time_only=no

        [if]
        
            [variable]
                name=crypt_wave
                boolean_equals=yes
            [/variable]
    
            [then]
    
                [set_variable]  
                    name=crypt_wave
                    rand=Revenant,Revenant,Revenant,Deathblade,Deathblade,Bone Shooter,Bone Shooter,Bone Shooter,Draug,Death Knight,Skeleton,Skeleton,Skeleton,Skeleton Archer,Skeleton Archer,Skeleton Archer
                [/set_variable]
    
                [unit]
                    type=$crypt_wave
                    x,y=28,15
                    facing=nw
                    side=4
                    placement=map_passable
                [/unit]

                [set_variable]  
                    name=crypt_wave
                    rand=Revenant,Revenant,Revenant,Deathblade,Deathblade,Bone Shooter,Bone Shooter,Bone Shooter,Draug,Death Knight,Skeleton,Skeleton,Skeleton,Skeleton Archer,Skeleton Archer,Skeleton Archer
                [/set_variable]
    
                [unit]
                    type=$crypt_wave
                    x,y=28,15
                    facing=nw
                    side=4
                    placement=map_passable
                [/unit]

                [set_variable]  
                    name=crypt_wave
                    rand=Revenant,Revenant,Revenant,Deathblade,Deathblade,Bone Shooter,Bone Shooter,Bone Shooter,Draug,Death Knight,Skeleton,Skeleton,Skeleton,Skeleton Archer,Skeleton Archer,Skeleton Archer
                [/set_variable]
    
                [unit]
                    type=$crypt_wave
                    x,y=28,15
                    facing=nw
                    side=4
                    placement=map_passable
                [/unit]
    
                {VARIABLE crypt_wave yes}
    
            [/then]
    
        [/if]

    [/event]

#ifdef EASY #bridges can break on EASY, buying the player more time and killing units
    [event]
        name=enter_hex
        first_time_only=no
        [filter]
            side=4
            x,y=22,3
        [/filter]

        {VARIABLE_OP bridge1 add 1}

        [if]
            [variable]
                name=bridge1
                greater_than=1
            [/variable]
            [then]

                [cancel_action][/cancel_action]
                [scroll_to]
                    highlight=yes
                    x,y=22,3
                [/scroll_to]
                [sound]
                    name=water-blast.wav
                [/sound]
                {MODIFY_TERRAIN Wo 22 3}
                {MODIFY_TERRAIN Ww 23 3}
                [kill]
                    x,y=22,3
                    animate=yes
                [/kill]
            [/then]
        [/if]
    [/event]

    [event]
        name=enter_hex
        first_time_only=no
        [filter]
            side=4
            x,y=23,4
        [/filter]

        {VARIABLE_OP bridge2 add 1}

        [if]
            [variable]
                name=bridge2
                greater_than=1
            [/variable]
            [then]

                [cancel_action][/cancel_action]
                [scroll_to]
                    highlight=yes
                    x,y=23,4
                [/scroll_to]
                [sound]
                    name=water-blast.wav
                [/sound]
                {MODIFY_TERRAIN Wo 23 4}
                {MODIFY_TERRAIN Ww 22 4}
                [kill]
                    x,y=23,4
                    animate=yes
                [/kill]
            [/then]
        [/if]
    [/event]
#endif

    [event] #Stuurg performs his ritual and breaks the curse
        name=moveto
        first_time_only=no

        [filter]
            id=Stuurg
            x,y=46,15
        [/filter]

        [filter_condition]
            [variable]
                name=curse_lifted
                not_equals=yes
            [/variable]
        [/filter_condition]

        [if]
            [have_unit]
                id=Gaethyn
            [/have_unit]
            [and]
                [have_unit]
                    type=Ghost
                    side=1
                [/have_unit]
            [/and]
            [then]
                [message]
                    speaker=Stuurg
                    message= _ "If I perform the ritual, it will also destroy the undead that are accompanying us."
                [/message]
                [message]
                    type=Ghost
                    side=1
                    message= _ "I wouldn't mind being released from this pitiful misery."
                [/message]
                [message]
                    speaker=Gaethyn
                    message= _ "But I would! It would mean I'll never get catch fish I came here for in the first place!"
                [/message]
                [message]
                    speaker=Stuurg
                    [option]
                        label= _ "Do the ritual"
                        [command]
                            [fire_event]
                                name=breaking_the_curse
                            [/fire_event]
                        [/command]
                    [/option]
                    [option]
                        label= _ "Wait, at least for the time being"
                    [/option]
                [/message]
            [/then]
            [else]
                [if]
                    [have_unit]
                        id=Gaethyn
                    [/have_unit]
                    [then]
                        [message]
                            speaker=Stuurg
                            message= _ "If I perform the ritual, it will also destroy you, Gaethyn."
                        [/message]
                        [message]
                            speaker=Gaethyn
                            message= _ "What? It would mean I'll never catch the fish I came here for in the first place!"
                        [/message]
                        [message]
                            speaker=Stuurg
                            [option]
                                label= _ "Do the ritual"
                                [command]
                                    [fire_event]
                                        name=breaking_the_curse
                                    [/fire_event]
                                [/command]
                            [/option]
                            [option]
                                label= _ "Wait, at least for the time being"
                            [/option]
                        [/message]
                    [/then]
                    [else]
                        [if]
                            [have_unit]
                                type=Ghost
                                side=1
                            [/have_unit]
                            [then]
                                [message]
                                    speaker=Stuurg
                                    message= _ "If I perform the ritual, it will also destroy the ghost who accompanies us."
                                [/message]
                                [message]
                                    type=Ghost
                                    side=1
                                    message= _ "I wouldn't mind being released from this pitiful misery."
                                [/message]
                                [message]
                                    speaker=Stuurg
                                    [option]
                                        label= _ "Do the ritual"
                                        [command]
                                            [fire_event]
                                                name=breaking_the_curse
                                            [/fire_event]
                                        [/command]
                                    [/option]
                                    [option]
                                        label= _ "Wait, at least for the time being"
                                    [/option]
                                [/message]
                            [/then]
                            [else]
                                [fire_event]
                                    name=breaking_the_curse
                                [/fire_event]
                            [/else]
                        [/if]
                    [/else]
                [/if]
            [/else]
        [/if]

    [/event]        
    [event]
        name=breaking_the_curse #todo: kill the ghost even if it's on the recall list?

        [remove_shroud]
            x="41,42,42,43,43,44,45,46,47,47,48,48,49,49,50,50,51,51,52,52,53,53"
            y="15-17,9,14-19,9-12,14-20,8-19,9-20,9-20,9-11,13-20,8-10,13-20,9-10,12-20,8-10,12-18,8-11,15-16,7-8,10-11,7-8,11-12"
        [/remove_shroud]

        [redraw]
        [/redraw]
        
        [animate_unit]
            flag=attack
            [filter]
                id=Stuurg
            [/filter]
            hits=kill
            [primary_attack]
                range=ranged
            [/primary_attack]
            [facing]
                x,y=46,16
            [/facing]
        [/animate_unit]

        {GENERIC_UNIT 1 (Fire Guardian) 44 15}

        [delay]
            time=750
        [/delay]

        {GENERIC_UNIT 1 (Fire Guardian) 47 17}

        [delay]
            time=750
        [/delay]

        {GENERIC_UNIT 1 (Fire Wraith) 46 18}

        [delay]
            time=500
        [/delay]

        [animate_unit]
            flag=attack
            [filter]
                x,y=47,17
            [/filter]
            hits=kill
            [primary_attack]
                range=ranged
            [/primary_attack]
            [facing]
                x,y=46,16
            [/facing]
        [/animate_unit]

        [delay]
            time=500
        [/delay]

        [animate_unit]
            flag=attack
            [filter]
                x,y=44,15
            [/filter]
            hits=kill
            [primary_attack]
                range=ranged
            [/primary_attack]
            [facing]
                x,y=45,16
            [/facing]
        [/animate_unit]

        [sound]
            name=fire.wav
        [/sound]

        {COLOR_ADJUST 10000 10000 10000}

        [hide_unit]
        [/hide_unit]

        [delay]
            time=500
        [/delay]

        [sound]
            name=skeleton-die-1.ogg
        [/sound]

        [delay]
            time=200
        [/delay]

        [sound]
            name=zombie-hit-4.ogg
        [/sound]

        [delay]
            time=200
        [/delay]

        [sound]
            name=skeleton-die-2.ogg
        [/sound]

        [delay]
            time=200
        [/delay]

        [sound]
            name=skeleton-big-die.ogg
        [/sound]

        [kill]
            side=4
            animate=no
        [/kill]

        [kill]
            side=1
            animate=no
            race=undead
        [/kill]

        [kill]
            side=1
            animate=no
            type=Fire Wraith,Fire Guardian
        [/kill]

        [delay]
            time=700
        [/delay]

        {COLOR_ADJUST 0 0 0}

        [unhide_unit]
        [/unhide_unit]

        {VARIABLE curse_lifted yes}
        {CLEAR_VARIABLE crypt_wave}
        {CLEAR_VARIABLE undead_wave}

    [/event]

    [event]
        name=moveto
        first_time_only=no
        [filter]
            id=Arshag
            x,y=52,8
        [/filter]

        [if]
            [have_unit]
                id=Linaera
            [/have_unit]
            [then]
                [message]
                    speaker=Arshag
                    [option]
                        label= _ "We'll go through the territory of the drakes!"
                        [command]
                            {VARIABLE the_dark_branch drakes}
                            [fire_event]
                                name=victory
                            [/fire_event]
                        [/command]
                    [/option]
                    [option]
                        label= _ "I'm not decided to go this way yet."
                    [/option]
                [/message]
            [/then]
            [else]
                {VARIABLE the_dark_branch drakes}
                [fire_event]
                    name=victory
                [/fire_event]
            [/else]
        [/if]
    [/event]

    [event]
        name=moveto
        first_time_only=no
        [filter]
            id=Arshag
            x,y=52,10
        [/filter]

        [filter_condition]
            [have_unit]
                id=Linaera
            [/have_unit]
        [/filter_condition]

        [message]
            speaker=Arshag
            [option]
                label= _ "We'll go through the deep tunnels."
                [command]
                    {VARIABLE the_dark_branch deep}
                    [fire_event]
                        name=victory
                    [/fire_event]
                [/command]
            [/option]
            [option]
                label= _ "I'm not decided to go this way yet."
            [/option]
        [/message]
    [/event]

    [event]
        name=victory

        {COND_SAY curse_lifted Toruk "We have lost many warriors to the undead. My only consolation is that they won't rise again in undeath." "It hurts to leave some of our warriors here, crawling through the tunnels until their remains finally rot away."}

        [message]
            speaker=Arshag
            message= _ "I'm sick of it. Logalmier had a hand in it, I'm almost sure of it."
        [/message]

        [message]
            speaker=Stuurg
            message= _ "The elves despise necromancy. They would only resort to it if they were truly desperate."
        [/message]

        [message]
            speaker=Arshag
            message= _ "Or out of arrogance."
        [/message]

        [message]
            speaker=Toruk
            message= _ "We know their kind very well. The puppeteers."
        [/message]

        [message]
            speaker=Arshag
            message= _ "Jevyan, our former master, was one of them. His greatest strength wasn't in raising corpses.
            
He dominated the orc chieftains with the same ease, using only threats and promises."
        [/message]

        [delay]
            time=1000
        [/delay]

        [message]
            speaker=Arshag
            message= _ "All I wanted was to settle peacefully on the continent. I thought we could come to an agreement with the other races if we acted in good faith.
            
But we have paid dearly for my foolishness."
        [/message]

        [message]
            speaker=Toruk
            message= _ "It worked with the dwarves."
        [/message]

        [message]
            speaker=Arshag
            message= _ "The same dwarves despise Stuurg's people, just because they look different and live near the ore veins.
            
Maybe our chiefs at Elensefar were right after all and a new home can only be won with a sword."
        [/message]

        [message]
            speaker=Stuurg
            message= _ "Why did they fail then?"
        [/message]

        [message]
            speaker=Arshag
            message= _ "Maybe they just lacked guile."
        [/message]
        
        [if] #creating Stuurg in case the player skipped the scenario via debug
            [not]
                [have_unit]
                    id=Stuurg
                    side=1
                [/have_unit]
            [/not]
            [then]
                [unit]
                    side=1
                    type=Troll Shaman
                    id=Stuurg
                    unrenamable=yes
                    name= _ "Stuurg"
                    x,y=recall,recall
                    facing=nw
                    [modifications]
                        {TRAIT_LOYAL_HERO}
                        {TRAIT_STRONG}
                    [/modifications]
                [/unit]
            [/then]
        [/if]

        #[if] #selecting the next scenario randomly in case the player used debug todo: broken for some reason
        #    [variable]
        #        name=the_dark_branch
        #        not_equals=drakes
        #    [/variable]
        #    [or]
        #        [variable]
        #            name=the_dark_branch
        #            not_equals=deep
        #        [/variable]
        #    [/or]
        #    [then]
        #        [set_variable]  
        #            name=the_dark_branch
        #            rand=deep,drakes
        #        [/set_variable]
        #    [/then]
        #[/if]

        [if]
            [variable]
                name=the_dark_branch
                equals=drakes
            [/variable]
            [then]
                [endlevel]
                    result=victory
                    next_scenario=05a_The_Fire
                    bonus=no
                    {NEW_GOLD_CARRYOVER 20}
                [/endlevel]
            [/then]
        [/if]

        [if]
            [variable]
                name=the_dark_branch
                equals=deep
            [/variable]
            [then]
                [endlevel]
                    result=victory
                    next_scenario=05b_The_Deep
                    bonus=yes
                    {NEW_GOLD_CARRYOVER 20}
                [/endlevel]
            [/then]
        [/if]


    [/event]

    [event]
        name=sighted
        [filter]
            side=1
        [/filter]
        [filter_second]
            id=BurnedOne
        [/filter_second]
        {HINT_ITEM}
    [/event]

    [event]
        name=time over
        [message]
            id=Arshag
            message= _ "We ate the last of the supplies.

We can't feed on mushrooms like trolls..."
        [/message]
    [/event]

[/scenario]
